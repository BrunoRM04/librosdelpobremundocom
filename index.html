<!DOCTYPE html>
<html lang="es">

<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Libros Del Pobre Mundo | Inicio</title>
  <link rel="stylesheet" href="public/css/styles.css">
  <link rel="shortcut icon" href="public/img/marca/icono.png">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

</head>

<body>

  <div class="barra-informativa">
    <div class="contenedor-frases">
      <span class="frase">
        M√°s de 20.000 t√≠tulos en nuestro cat√°logo |
        Aceptamos transferencia bancaria, mercado pago, tarjeta de d√©bito, cr√©dito y efectivo |
        Compras con env√≠o gratis mayor a $1500 en Montevideo |
        Compras con env√≠o gratis mayor a $2000 al interior del pa√≠s.
      </span>
    </div>
  </div>

  <header class="encabezado-principal">

    <div class="contenedor-logo">
      <a href="index.html"><img src="public/img/marca/blanco.png" alt="Logotipo" class="imagen-logotipo"></a>
    </div>

    <div class="iconos-acciones">
      <i class='bx bx-heart icono-favoritos' id="abrirFavoritos"></i>
      <i class='bx bx-cart icono-carrito'></i>
      <i class='bx bx-menu icono-menu' id="botonMenu"></i>
    </div>

  </header>

  <div class="menu-completo" id="menuCompleto">
    <i class='bx bx-x icono-cerrar' id="botonCerrar"></i>
    <nav class="contenido-menu">
      <a href="index.html">üè† Inicio</a>
      <a href="catalogo.html">üìö Cat√°logo</a>
    </nav>
  </div>

  <main>

    <div class="favoritos-lateral" id="favoritosLateral">
      <div class="encabezado-favoritos">
        <h2 class="titulo-favoritos">Tus Favoritos</h2>
        <i class='bx bx-x cerrar-favoritos' id="cerrarFavoritos"></i>
      </div>
      <div class="contenido-favoritos" id="contenidoFavoritos"></div>
    </div>

    <div class="carrito-lateral" id="carritoLateral">
      <div class="encabezado-carrito">
        <h2 class="titulo-carrito">Tu Carrito</h2>
        <i class='bx bx-x cerrar-carrito' id="cerrarCarrito"></i>
      </div>
      <div class="contenido-carrito" id="contenidoCarrito"></div>
      <div class="total-carrito">
        <span>Total:</span>
        <strong id="totalCarrito">UYU 0</strong>
      </div>
      <button class="boton-comprar-ahora" id="botonComprarAhora">
        <i class='bx bx-credit-card'></i> Comprar ahora </button></a>
    </div>
    <div class="fondo-oscuro" id="fondoOscuro"></div>

    <section class="seccion-buscador-libros">
      <div class="contenedor-buscador">
        <h1 class="titulo-buscador">Explora en nuestro cat√°logo</h1>
        <p class="descripcion-buscador">Busca titulo, autor, isbn y m√°s.</p>
        <form class="grupo-buscador">
          <input type="text" class="campo-buscador" placeholder="Buscar un libro...">
          <button class="boton-buscador" type="submit">Buscar</button>
        </form>
      </div>
    </section>

    <section class="resultados-buscador-libros" id="resultados-buscador">
      <div class="contenedor-resultados">

      </div>
    </section>

    <section class="seccion-libros-destacados">
      <div class="contenedor-libros-destacados">
        <h2 class="titulo-libros-destacados">Destacados</h2>

        <div class="contenedor-carrusel">
          <button class="flecha-carrusel flecha-izquierda" id="flecha-izquierda">
            <i class='bx bx-chevron-left'></i>
          </button>

          <div class="carrusel-libros" id="carrusel-destacados"></div>

          <button class="flecha-carrusel flecha-derecha" id="flecha-derecha">
            <i class='bx bx-chevron-right'></i>
          </button>
        </div>
      </div>
    </section>

    <section class="seccion-libros-destacados seccion-secundaria">
      <div class="contenedor-libros-destacados">
        <h2 class="titulo-libros-destacados">Novedades</h2>

        <div class="contenedor-carrusel">
          <button class="flecha-carrusel flecha-izquierda" id="flecha-izquierda-novedades">
            <i class='bx bx-chevron-left'></i>
          </button>

          <div class="carrusel-libros" id="carrusel-novedades"></div>

          <button class="flecha-carrusel flecha-derecha" id="flecha-derecha-novedades">
            <i class='bx bx-chevron-right'></i>
          </button>
        </div>
      </div>
    </section>

    <section class="seccion-libros-destacados seccion-secundaria">
      <div class="contenedor-libros-destacados">
        <h2 class="titulo-libros-destacados">Otros T√≠tulos</h2>

        <div class="contenedor-carrusel">
          <button class="flecha-carrusel flecha-izquierda" id="flecha-izquierda-otros">
            <i class='bx bx-chevron-left'></i>
          </button>

          <div class="carrusel-libros" id="carrusel-otros"></div>

          <button class="flecha-carrusel flecha-derecha" id="flecha-derecha-otros">
            <i class='bx bx-chevron-right'></i>
          </button>
        </div>
      </div>
    </section>

  </main>

  <footer class="pie-pagina">

    <div class="contenedor-footer">

      <div class="seccion-derechos">
        <p class="texto-derechos">¬© 2025 Libros Del Pobre Mundo</p>
      </div>

      <div class="seccion-enlaces">
        <a href="index.html" class="enlace-footer">Inicio</a>
        <a href="catalogo.html" class="enlace-footer">Cat√°logo</a>
        <a href="carrito.html" class="enlace-footer">Carrito</a>
        <a href="contacto.html" class="enlace-footer">Contacto</a>
      </div>

      <div class="seccion-redes">
        <a href="https://www.instagram.com/libros_pobremundo/" target="_blank" class="icono-red">
          <i class='bx bxl-instagram'></i>
        </a>
        <a href="https://wa.me/59894090711" target="_blank" class="icono-red">
          <i class='bx bxl-whatsapp'></i>
        </a>
      </div>

      <div class="seccion-info">
        <p class="texto-info">Montevideo, Uruguay. | Env√≠os a todo el pa√≠s</p>
      </div>

    </div>

  </footer>

  <script>

    const botonMenu = document.getElementById('botonMenu');
    const menuCompleto = document.getElementById('menuCompleto');
    const botonCerrar = document.getElementById('botonCerrar');

    botonMenu.addEventListener('click', () => {
      menuCompleto.classList.add('activo');
    });

    botonCerrar.addEventListener('click', () => {
      menuCompleto.classList.remove('activo');
    });

    const librosDestacados = [60, 1040, 1044, 4, 5, 6];
    const librosNovedades = [1055, 2, 3, 4, 5, 6];
    const librosOtros = [1, 2, 3, 4, 5, 6];

    function cargarLibros(carruselId, ids) {
      fetch('libros.json')
        .then(res => res.json())
        .then(libros => {
          const contenedor = document.getElementById(carruselId);

          ids
            .map(id => libros.find(libro => Number(libro.id) === id))
            .filter(libro => libro)
            .forEach(libro => {
              const precioOriginal = parseFloat(libro.precio.replace(/[^\d.]/g, ""));
              const precioFinal = Math.round(precioOriginal * 0.95);

              let rutaImagen = libro.imagen;
              if (rutaImagen.startsWith("http")) {
              } else if (rutaImagen.startsWith("./")) {
                rutaImagen = rutaImagen.replace("./", "");
              } else {
                rutaImagen = `public/img/portadas/${rutaImagen.replace(/%20/g, ' ')}`;
              }

              const tarjeta = document.createElement('div');
              tarjeta.classList.add('tarjeta-libro');
              tarjeta.innerHTML = `
  <span class="etiqueta-descuento">-5%</span>
  <button class="boton-favorito" data-id="${libro.id}">
    <i class='bx bx-heart'></i>
  </button>
  <a href="libro-detalle.html?id=${libro.id}">
    <img src="${rutaImagen}" alt="Portada de ${libro.titulo}" class="imagen-libro" onerror="this.src='public/img/portadas/default.jpg'">
  </a>
  <div class="info-libro">
    <h3 class="titulo-libro" title="${libro.titulo}">${libro.titulo}</h3>
    <p class="autor-libro" title="${libro.autor}">${libro.autor}</p>
  </div>
  <p class="precio-libro">
    <span class="precio-original">UYU ${precioOriginal}</span>
    <span class="precio-descuento">UYU ${precioFinal}</span>
  </p>
  <div class="botones-libro">
    <a href="libro-detalle.html?id=${libro.id}" class="boton-ver">Ver m√°s</a>
    <button class="boton-anadir"><i class='bx bx-cart-alt'></i> A√±adir</button>
  </div>
`;
              contenedor.appendChild(tarjeta);
            });
        });
    }

    cargarLibros("carrusel-destacados", librosDestacados);
    cargarLibros("carrusel-novedades", librosNovedades);
    cargarLibros("carrusel-otros", librosOtros);

    function configurarFlechas(flechaIzqId, flechaDerId, carruselId) {
      document.getElementById(flechaIzqId).addEventListener("click", () => {
        document.getElementById(carruselId).scrollBy({ left: -300, behavior: "smooth" });
      });
      document.getElementById(flechaDerId).addEventListener("click", () => {
        document.getElementById(carruselId).scrollBy({ left: 300, behavior: "smooth" });
      });
    }

    configurarFlechas("flecha-izquierda", "flecha-derecha", "carrusel-destacados");
    configurarFlechas("flecha-izquierda-novedades", "flecha-derecha-novedades", "carrusel-novedades");
    configurarFlechas("flecha-izquierda-otros", "flecha-derecha-otros", "carrusel-otros");

    let carrito = JSON.parse(localStorage.getItem('carrito')) || [];
    actualizarContadorCarrito();
    actualizarCarrito();

    function actualizarContadorCarrito() {
      const totalLibros = carrito.reduce((acc, item) => acc + item.cantidad, 0);
      const iconoCarrito = document.querySelector('.icono-carrito');
      iconoCarrito.setAttribute('data-contador', totalLibros);
    }

    document.addEventListener("click", (e) => {
      if (e.target.closest('.boton-anadir')) {
        const tarjeta = e.target.closest('.tarjeta-libro');
        const titulo = tarjeta.querySelector('.titulo-libro').textContent;
        const autor = tarjeta.querySelector('.autor-libro').textContent;
        const precio = parseInt(tarjeta.querySelector('.precio-descuento').textContent.replace(/[^\d]/g, ""));
        const imagen = tarjeta.querySelector('.imagen-libro').src;

        const existente = carrito.find(item => item.titulo === titulo);
        if (existente) {
          existente.cantidad++;
        } else {
          carrito.push({ titulo, autor, precio, imagen, cantidad: 1 });
        }

        actualizarContadorCarrito();
        actualizarCarrito();
      }
    });

    function actualizarCarrito() {
      const contenedor = document.getElementById('contenidoCarrito');
      contenedor.innerHTML = '';
      let total = 0;

      carrito.forEach((item, i) => {
        total += item.precio * item.cantidad;

        const div = document.createElement('div');
        div.classList.add('item-carrito');
        div.innerHTML = `
          <img src="${item.imagen}" alt="${item.titulo}">
          <div class="item-detalles">
            <h4>${item.titulo}</h4>
            <p>${item.autor}</p>
            <div class="controles-cantidad">
              <button onclick="cambiarCantidad(${i}, -1)">-</button>
              <span>${item.cantidad}</span>
              <button onclick="cambiarCantidad(${i}, 1)">+</button>
            </div>
          </div>
          <div class="item-acciones">
  <strong>UYU ${item.precio * item.cantidad}</strong>
  <i class='bx bx-trash boton-eliminar' onclick="eliminarItem(${i})"></i>
</div>
        `;
        contenedor.appendChild(div);
      });

      document.getElementById('totalCarrito').textContent = `UYU ${total}`;
      localStorage.setItem('carrito', JSON.stringify(carrito));
    }

    function cambiarCantidad(i, cambio) {
      carrito[i].cantidad += cambio;
      if (carrito[i].cantidad <= 0) carrito.splice(i, 1);
      actualizarContadorCarrito();
      actualizarCarrito();
    }

    function eliminarItem(i) {
      carrito.splice(i, 1);
      actualizarContadorCarrito();
      actualizarCarrito();
    }

    document.querySelector('.icono-carrito').addEventListener('click', () => {
      document.getElementById('carritoLateral').classList.add('activo');
      document.getElementById('fondoOscuro').classList.add('activo');
    });

    document.getElementById('cerrarCarrito').addEventListener('click', () => {
      document.getElementById('carritoLateral').classList.remove('activo');
      document.getElementById('fondoOscuro').classList.remove('activo');
    });

    document.getElementById('botonComprarAhora')?.addEventListener('click', () => {
      if (carrito.length === 0) {
        alert("Tu carrito est√° vac√≠o.");
        return;
      }

      localStorage.setItem('carrito', JSON.stringify(carrito));

      window.location.href = "finalizar-compra.html";
    });

    let librosCache = [];

    async function cargarLibrosBuscador() {
      if (librosCache.length === 0) {
        try {
          const respuesta = await fetch('./libros.json');
          const data = await respuesta.json();
          if (Array.isArray(data)) librosCache = data;
        } catch (err) {
          console.error("Error al cargar libros.json", err);
        }
      }
    }

    function mostrarResultadosFiltrados(termino) {
      const contenedor = document.querySelector('#resultados-buscador .contenedor-resultados');
      contenedor.innerHTML = '';

      if (termino.length < 2) return;

      const filtrados = librosCache.filter(libro => {
        const titulo = libro.titulo?.toLowerCase() || '';
        const autor = libro.autor?.toLowerCase() || '';
        const editorial = libro.editorial?.toLowerCase() || '';
        const isbn = String(libro.isbn || '');

        return (
          titulo.includes(termino) ||
          autor.includes(termino) ||
          editorial.includes(termino) ||
          isbn.includes(termino)
        );
      });

      if (filtrados.length === 0) {
        contenedor.innerHTML = '<p>No se encontraron resultados.</p>';
        return;
      }

      filtrados.forEach(libro => {
        const rutaImagen = libro.imagen?.replace('./', '') || 'public/img/portadas/default.jpg';
        const resultadoHTML = `
      <div class="item-resultado-libro">
        <img src="${rutaImagen}" alt="${libro.titulo}" class="imagen-resultado-libro" onerror="this.src='public/img/portadas/default.jpg'">
        <div class="info-resultado-libro">
          <h3 class="titulo-resultado-libro">${libro.titulo || 'Sin t√≠tulo'}</h3>
          <p class="autor-resultado-libro">${libro.autor || 'Desconocido'}</p>
        </div>
        <div class="acciones-resultado-libro">
          <a href="libro-detalle.html?id=${libro.id}" class="boton-ver-detalle">Ver m√°s</a>
        </div>
      </div>
    `;
        contenedor.innerHTML += resultadoHTML;
      });
    }

    function debounce(funcion, retraso) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => funcion.apply(this, args), retraso);
      };
    }

    function anadirLibroDesdeBusqueda(titulo, autor, precio, imagen) {
      const existente = carrito.find(item => item.titulo === titulo);
      if (existente) {
        existente.cantidad++;
      } else {
        carrito.push({ titulo, autor, precio: parseInt(precio), imagen, cantidad: 1 });
      }
      actualizarContadorCarrito();
      actualizarCarrito();
      localStorage.setItem('carrito', JSON.stringify(carrito)); // ‚úÖ A√ëADE ESTO
    }

    const campoBuscador = document.querySelector('.campo-buscador');

    campoBuscador.addEventListener('input', debounce(async (e) => {
      const termino = e.target.value.trim().toLowerCase();
      await cargarLibrosBuscador();
      mostrarResultadosFiltrados(termino);
    }, 300));

    let favoritos = JSON.parse(localStorage.getItem('favoritos')) || [];

    document.addEventListener("click", e => {
      const boton = e.target.closest('.boton-favorito');
      if (boton) {
        const idLibro = boton.dataset.id;
        const index = favoritos.indexOf(idLibro);

        if (index > -1) {
          favoritos.splice(index, 1);
          boton.classList.remove('activo');
        } else {
          favoritos.push(idLibro);
          boton.classList.add('activo');
        }

        localStorage.setItem('favoritos', JSON.stringify(favoritos));
      }
    });

    function marcarFavoritosIniciales() {
      setTimeout(() => {
        document.querySelectorAll('.boton-favorito').forEach(boton => {
          if (favoritos.includes(boton.dataset.id)) {
            boton.classList.add('activo');
          }
        });
      }, 300);
    }

    window.addEventListener("load", marcarFavoritosIniciales);

    const iconoFavoritos = document.getElementById('abrirFavoritos');
    const contenedorFavoritos = document.getElementById('contenidoFavoritos');
    const panelFavoritos = document.getElementById('favoritosLateral');
    const cerrarFavoritos = document.getElementById('cerrarFavoritos');

    iconoFavoritos.addEventListener('click', () => {
      mostrarFavoritos();
      panelFavoritos.classList.add('activo');
      document.getElementById('fondoOscuro').classList.add('activo');
    });

    cerrarFavoritos.addEventListener('click', () => {
      panelFavoritos.classList.remove('activo');
      document.getElementById('fondoOscuro').classList.remove('activo');
    });

    function mostrarFavoritos() {
      contenedorFavoritos.innerHTML = '';
      fetch('libros.json')
        .then(res => res.json())
        .then(libros => {
          favoritos.forEach(id => {
            const libro = libros.find(l => String(l.id) === id);
            if (libro) {
              let rutaImagen = libro.imagen || '';

              if (rutaImagen.startsWith('http')) {
                // URL externa
              } else {
                // Ruta local limpia
                rutaImagen = rutaImagen
                  .replace(/^\.?\/*/, '')
                  .replace(/%20/g, ' ')
                  .split('/').pop();

                rutaImagen = `public/img/portadas/${rutaImagen}`;
              }

              const item = document.createElement('div');
              item.classList.add('item-favorito');

              item.innerHTML = `
            <a href="libro-detalle.html?id=${libro.id}" class="enlace-favorito">
              <img src="${rutaImagen}" alt="${libro.titulo}" 
                onerror="this.onerror=null;this.src='https://via.placeholder.com/270x360?text=Sin+imagen'">
              <div class="info-favorito">
                <h4>${libro.titulo}</h4>
                <p>${libro.autor}</p>
              </div>
            </a>
            <button class="eliminar-favorito" data-id="${libro.id}" title="Eliminar de favoritos">
              <i class='bx bx-trash'></i>
            </button>
          `;

              contenedorFavoritos.appendChild(item);
            }
          });

          if (favoritos.length === 0) {
            contenedorFavoritos.innerHTML = '<p>No tienes libros en favoritos.</p>';
          }

          document.querySelectorAll('.eliminar-favorito').forEach(boton => {
            boton.addEventListener('click', e => {
              const idEliminar = e.currentTarget.dataset.id;
              favoritos = favoritos.filter(id => id !== idEliminar);
              localStorage.setItem('favoritos', JSON.stringify(favoritos));
              mostrarFavoritos();
              marcarFavoritosIniciales();
            });
          });
        });
    }
  </script>


</body>

</html>
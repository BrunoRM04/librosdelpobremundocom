<!DOCTYPE html>
<html lang="es">

<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Libros Del Pobre Mundo | Inicio</title>
  <link rel="stylesheet" href="public/css/styles.css?v=99">
  <link rel="shortcut icon" href="public/img/marca/icono.png">
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

</head>

<body>

  <div class="barra-informativa">
    <div class="contenedor-frases">
      <span class="frase">
        M치s de 20.000 t칤tulos en nuestro cat치logo |
        Aceptamos transferencia bancaria, mercado pago, tarjeta de d칠bito, cr칠dito y efectivo |
        Compras con env칤o gratis mayor a $1500 en Montevideo |
        Compras con env칤o gratis mayor a $2000 al interior del pa칤s.
      </span>
    </div>
  </div>

  <header class="encabezado-principal">

    <div class="contenedor-logo">
      <a href="index.html"><img src="public/img/marca/blanco.png" alt="Logotipo" class="imagen-logotipo"></a>
    </div>

    <div class="iconos-acciones">
      <i class='bx bx-heart icono-favoritos' id="abrirFavoritos"></i>
      <i class='bx bx-cart icono-carrito'></i>
      <i class='bx bx-menu icono-menu' id="botonMenu"></i>
    </div>

  </header>

  <div class="menu-completo" id="menuCompleto">
    <i class='bx bx-x icono-cerrar' id="botonCerrar"></i>
    <nav class="contenido-menu">
      <a href="index.html">游 Inicio</a>
      <a href="catalogo.html">游닄 Cat치logo</a>
    </nav>
  </div>

  <main>

    <div class="carrusel-banner">
      <div class="carrusel-slide activo">
      </div>
    </div>

    <div class="favoritos-lateral" id="favoritosLateral">
      <div class="encabezado-favoritos">
        <h2 class="titulo-favoritos">Tus Favoritos</h2>
        <i class='bx bx-x cerrar-favoritos' id="cerrarFavoritos"></i>
      </div>
      <div class="contenido-favoritos" id="contenidoFavoritos"></div>
    </div>

    <div class="carrito-lateral" id="carritoLateral">
      <div class="encabezado-carrito">
        <h2 class="titulo-carrito">Tu Carrito</h2>
        <i class='bx bx-x cerrar-carrito' id="cerrarCarrito"></i>
      </div>

      <div class="contenido-carrito" id="contenidoCarrito"></div>

      <div class="zona-total-y-boton">
        <div class="total-carrito">
          <span>Total:</span>
          <strong id="totalCarrito">UYU 0</strong>
        </div>
        <button class="boton-comprar-ahora" id="botonComprarAhora">
          <i class='bx bx-credit-card'></i> Comprar ahora
        </button>
      </div>
    </div>
    <div class="fondo-oscuro" id="fondoOscuro"></div>

    <section class="seccion-buscador-libros">
      <div class="contenedor-buscador">
        <h1 class="titulo-buscador">Explora en nuestro cat치logo</h1>
        <p class="descripcion-buscador">Busca titulo, autor, isbn y m치s.</p>
        <form class="grupo-buscador" id="formBuscador">
          <input type="text" class="campo-buscador" placeholder="Buscar un libro...">
          <button class="boton-buscador" type="submit">Buscar</button>
        </form>
      </div>
    </section>

    <section class="resultados-buscador-libros" id="resultados-buscador">
      <div class="contenedor-resultados">

      </div>
    </section>

    <section class="seccion-libros-destacados">
      <div class="contenedor-libros-destacados">
        <h2 class="titulo-libros-destacados">칔ltimos Ingresos</h2>

        <div class="contenedor-carrusel">
          <button class="flecha-carrusel flecha-izquierda" id="flecha-izquierda">
            <i class='bx bx-chevron-left'></i>
          </button>

          <div class="carrusel-libros" id="carrusel-destacados"></div>

          <button class="flecha-carrusel flecha-derecha" id="flecha-derecha">
            <i class='bx bx-chevron-right'></i>
          </button>
        </div>
      </div>
    </section>

    <section class="seccion-libros-destacados seccion-secundaria">
      <div class="contenedor-libros-destacados">
        <h2 class="titulo-libros-destacados">Destacados Pobre Mundo</h2>

        <div class="contenedor-carrusel">
          <button class="flecha-carrusel flecha-izquierda" id="flecha-izquierda-novedades">
            <i class='bx bx-chevron-left'></i>
          </button>

          <div class="carrusel-libros" id="carrusel-novedades"></div>

          <button class="flecha-carrusel flecha-derecha" id="flecha-derecha-novedades">
            <i class='bx bx-chevron-right'></i>
          </button>
        </div>
      </div>
    </section>

    <a href="https://wa.me/59894090711" class="burbuja-whatsapp" target="_blank" aria-label="Chatear por WhatsApp">
      <i class='bx bxl-whatsapp'></i>
    </a>

  </main>

  <footer class="pie-pagina">

    <div class="contenedor-footer">

      <div class="seccion-derechos">
        <p class="texto-derechos">춸 2025 Libros Del Pobre Mundo</p>
      </div>

      <div class="seccion-enlaces">
        <a href="index.html" class="enlace-footer">Inicio</a>
        <a href="catalogo.html" class="enlace-footer">Cat치logo</a>
        <a href="carrito.html" class="enlace-footer">Carrito</a>
        <a href="contacto.html" class="enlace-footer">Contacto</a>
      </div>

      <div class="seccion-redes">
        <a href="https://www.instagram.com/libros_pobremundo/" target="_blank" class="icono-red">
          <i class='bx bxl-instagram'></i>
        </a>
        <a href="https://wa.me/59894090711" target="_blank" class="icono-red">
          <i class='bx bxl-whatsapp'></i>
        </a>
      </div>

      <div class="seccion-info">
        <p class="texto-info">Montevideo, Uruguay. | Env칤os a todo el pa칤s</p>
      </div>

    </div>

  </footer>

  <script>

    let index = 0;
    const slides = document.querySelectorAll(".carrusel-slide");

    setInterval(() => {
      slides[index].classList.remove("activo");
      index = (index + 1) % slides.length;
      slides[index].classList.add("activo");
    }, 3000);

    const botonMenu = document.getElementById('botonMenu');
    const menuCompleto = document.getElementById('menuCompleto');
    const botonCerrar = document.getElementById('botonCerrar');

    botonMenu.addEventListener('click', () => {
      menuCompleto.classList.add('activo');
    });

    botonCerrar.addEventListener('click', () => {
      menuCompleto.classList.remove('activo');
    });

    const librosDestacados = [1217, 1218, 1219, 1220, 1221, 1222, 1215, 1216, 1137, 1138, 1139, 1128, 1135, 1136, 1130, 1129, 1077, 1079, 306, 294, 863, 864];
    const librosNovedades = [1215, 1216, 1131, 1132, 1133, 1134, 1123, 1124, 1125, 1126, 1119];

    function cargarLibros(carruselId, ids) {

      fetch(`api/carrusel.php?ids=${ids.join(',')}`)
        .then(r => r.json())
        .then(libros => {

          const contenedor = document.getElementById(carruselId);

          ids.map(id => libros.find(l => Number(l.id) === id))
            .filter(l => l)
            .forEach(libro => {

              const precioOriginal = parseInt(libro.precio);
              const precioFinal = Math.round(precioOriginal * 0.9);

              let rutaImagen = libro.imagen;
              if (!rutaImagen.startsWith("http")) {
                rutaImagen = `public/img/portadas/${rutaImagen.replace(/^.*[\\/]/, '')}`;
              }

              const tarjeta = document.createElement('div');
              tarjeta.classList.add('tarjeta-libro');

              tarjeta.innerHTML = `
      <span class="etiqueta-descuento">-10%</span>
      <button class="boton-favorito" data-id="${libro.id}">
        <i class='bx bx-heart'></i>
      </button>
      <a href="libro-detalle.html?id=${libro.id}">
        <img src="${rutaImagen}" 
          alt="Portada de ${libro.titulo}" 
          class="imagen-libro"
          onerror="this.src='public/img/portadas/default.jpg'">
      </a>
      <div class="info-libro">
        <h3 class="titulo-libro">${libro.titulo}</h3>
        <p class="autor-libro">${libro.autor}</p>
      </div>
      <p class="precio-libro">
        <span class="precio-original">UYU ${precioOriginal}</span>
        <span class="precio-descuento">UYU ${precioFinal}</span>
      </p>
<div class="botones-libro">
  <a href="libro-detalle.html?id=${libro.id}" class="boton-ver">Ver m치s</a>

  ${Number(libro.stock) > 0
                  ? `<button class="boton-anadir"><i class='bx bx-cart-alt'></i> A침adir</button>`
                  : `<a href="https://wa.me/59894090711?text=Hola,%20quiero%20consultar%20por%20el%20libro%20${encodeURIComponent(libro.titulo)}"
        target="_blank"
        class="boton-consultar">
        <i class='bx bxl-whatsapp'></i> Consultar
       </a>`
                }
</div>
      `;

              contenedor.appendChild(tarjeta);

            });

        });

    }

    cargarLibros("carrusel-destacados", librosDestacados);
    cargarLibros("carrusel-novedades", librosNovedades);
    cargarLibros("carrusel-otros", librosOtros);

    function configurarFlechas(i, d, c) {
      document.getElementById(i).addEventListener("click", () => {
        document.getElementById(c).scrollBy({ left: -300, behavior: "smooth" });
      });
      document.getElementById(d).addEventListener("click", () => {
        document.getElementById(c).scrollBy({ left: 300, behavior: "smooth" });
      });
    }

    configurarFlechas("flecha-izquierda", "flecha-derecha", "carrusel-destacados");
    configurarFlechas("flecha-izquierda-novedades", "flecha-derecha-novedades", "carrusel-novedades");
    configurarFlechas("flecha-izquierda-otros", "flecha-derecha-otros", "carrusel-otros");

    let carrito = JSON.parse(localStorage.getItem("carrito")) || [];

    let librosCache = [];
    let stockCache = [];

    fetch(`api/carrusel.php?ids=${librosDestacados.concat(librosNovedades, librosOtros).join(',')}`)
      .then(r => r.json())
      .then(data => librosCache = data);

    fetch('api/libros.php')
      .then(r => r.json())
      .then(data => stockCache = data)
      .catch(() => { });

    function obtenerLibroPorTitulo(titulo) {
      return stockCache.find(l => l.titulo === titulo) || librosCache.find(l => l.titulo === titulo);
    }

    function obtenerStockPorTitulo(titulo) {
      const stockCompleto = stockCache.find(l => l.titulo === titulo)?.stock;
      const stockCarrusel = librosCache.find(l => l.titulo === titulo)?.stock;
      return Number(stockCompleto ?? stockCarrusel ?? 1);
    }

    function actualizarContadorCarrito() {
      const total = carrito.reduce((a, i) => a + i.cantidad, 0);
      document.querySelector(".icono-carrito")?.setAttribute("data-contador", total);
    }

    function actualizarCarrito() {

      const contenedor = document.getElementById("contenidoCarrito");
      if (!contenedor) return;

      contenedor.innerHTML = "";
      let total = 0;

      carrito.forEach((item, i) => {

        total += item.precio * item.cantidad;

        contenedor.innerHTML += `
    <div class="item-carrito">
      <img src="${item.imagen}">
      <div class="item-detalles">
  <h4>${item.titulo}</h4>
  <p>${item.autor}</p>

  <div class="controles-cantidad">
    <button onclick="cambiarCantidad(${i},-1)">-</button>
    <span>${item.cantidad}</span>
    <button onclick="cambiarCantidad(${i},1)">+</button>
  </div>
</div>

      <div>
        <strong>UYU ${item.precio * item.cantidad}</strong>
        <i class='bx bx-trash' onclick="eliminarItem(${i})"></i>
      </div>
    </div>
    `;
      });

      document.getElementById("totalCarrito").textContent = `UYU ${total}`;
      localStorage.setItem("carrito", JSON.stringify(carrito));
    }

    document.addEventListener("click", e => {

      if (e.target.closest(".boton-anadir")) {

        const t = e.target.closest(".tarjeta-libro");
        const titulo = t.querySelector(".titulo-libro").textContent;
        const autor = t.querySelector(".autor-libro").textContent;
        const precio = parseInt(t.querySelector(".precio-descuento").textContent.replace(/\D/g, ""));
        const imagen = t.querySelector("img").src;

        const libroDatos = obtenerLibroPorTitulo(titulo);
        const stock = Number(libroDatos?.stock ?? 1);
        const idLibro = libroDatos?.id;

        const existe = carrito.find(i => i.titulo === titulo);

        if (existe) {
          if (idLibro && !existe.id) existe.id = idLibro;
          existe.stock = stock;

          if (existe.cantidad < stock) {
            existe.cantidad++;
          } else {
            alert("No hay m치s stock disponible para este libro.");
          }

        } else {

          carrito.push({ id: idLibro, titulo, autor, precio, imagen, cantidad: 1, stock });

        }

        actualizarContadorCarrito();
        actualizarCarrito();
      }

    });

    function cambiarCantidad(i, c) {
      const stock = Number(carrito[i].stock ?? obtenerStockPorTitulo(carrito[i].titulo) ?? 1);
      if (c > 0 && carrito[i].cantidad >= stock) {
        alert("Has alcanzado el m치ximo disponible en stock.");
        return;
      }
      carrito[i].cantidad += c;
      if (carrito[i].cantidad <= 0) carrito.splice(i, 1);
      actualizarContadorCarrito();
      actualizarCarrito();
    }

    function eliminarItem(i) {
      carrito.splice(i, 1);
      actualizarContadorCarrito();
      actualizarCarrito();
    }

    document.querySelector(".icono-carrito")?.addEventListener("click", () => {
      document.getElementById("carritoLateral").classList.add("activo");
      document.getElementById("fondoOscuro").classList.add("activo");
    });

    document.getElementById("cerrarCarrito")?.addEventListener("click", () => {
      document.getElementById("carritoLateral").classList.remove("activo");
      document.getElementById("fondoOscuro").classList.remove("activo");
    });

    document.getElementById("botonComprarAhora")?.addEventListener("click", () => {
      if (carrito.length === 0) return alert("Tu carrito est치 vac칤o.");
      localStorage.setItem("carrito", JSON.stringify(carrito));
      window.location.href = "finalizar-compra.html";
    });

    actualizarContadorCarrito();
    actualizarCarrito();

    function debounce(fn, delay) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), delay);
      }
    }

    const campoBuscador = document.querySelector(".campo-buscador");

    const formBuscador = document.getElementById("formBuscador");

    formBuscador.addEventListener("submit", e => {
      e.preventDefault();
    });

    campoBuscador.addEventListener("input", debounce(async e => {

      const q = e.target.value.trim();
      const cont = document.querySelector("#resultados-buscador .contenedor-resultados");
      cont.innerHTML = "";
      if (q.length < 2) return;

      const r = await fetch(`api/buscar.php?q=${encodeURIComponent(q)}`);
      const libros = await r.json();

      libros.forEach(l => {

        let img = l.imagen;
        if (!img.startsWith("http")) {
          img = `public/img/portadas/${img.replace(/^.*[\\/]/, '')}`;
        }

        cont.innerHTML += `
<div class="item-resultado-libro">
  <img src="${img}" 
       class="imagen-resultado-libro"
       onerror="this.src='public/img/portadas/default.jpg'">

  <div class="info-resultado-libro">
    <h3 class="titulo-resultado-libro">${l.titulo}</h3>
    <p class="autor-resultado-libro">${l.autor}</p>
  </div>

  <div class="acciones-resultado-libro">
    <a href="libro-detalle.html?id=${l.id}" class="boton-ver-detalle">Ver m치s</a>
  </div>
</div>
    `;
      });

    }, 300));

    let favoritos = JSON.parse(localStorage.getItem("favoritos")) || [];

    document.addEventListener("click", e => {
      const b = e.target.closest(".boton-favorito");
      if (!b) return;
      const id = b.dataset.id;
      const i = favoritos.indexOf(id);
      if (i > -1) { favoritos.splice(i, 1); b.classList.remove("activo") }
      else { favoritos.push(id); b.classList.add("activo") }
      localStorage.setItem("favoritos", JSON.stringify(favoritos));
    });

  </script>


</body>

</html>